{% extends 'base.html' %}
{% load static %}

{% block title %}COE Portal{% endblock %}

{% block link %}
<link rel="stylesheet" type="text/css" href="{% static 'coe_css.css' %}">
{% endblock %}

{% block logo %}<a class="navbar-brand" style="color: #343a40;">{{request.user.first_name}}
    {{request.user.last_name}}</a>{% endblock %}

{% block logout_btn %}<a class="nav-link" href="{% url 'user_logout' %}"
    style="color: #6c757d; text-decoration: none;">Logout</a>{% endblock %}

{% block content %}

{% if messages %}
{% for message in messages %}
<div class="alert alert-success alert-dismissible fade show coe-alert" role="alert">
    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
        <span aria-hidden="true">×</span>
    </button>
    {{message}}
</div>
{% endfor %}
{% endif %}

<div class="alerts"></div>

<ul class="nav nav-tabs nav-fill coe-tabs" role="tablist">
    <li class="nav-item">
        <a class="nav-link active" data-toggle="tab" href="#prequest">Send Request</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" data-toggle="tab" href="#arequest">Request Status</a>
    </li>
</ul>

<div class="tab-content coe-tab-content">
    <!-- Send Request Tab -->
    <div id="prequest" class="container tab-pane active"><br>
        <form method="POST" id="form" class="coe-form" submit-url="{% url 'get_teachers' %}">{% csrf_token %}
            <div class="form-group">
                <label for="course">Select Course:</label>
                <select class="form-control" id="course" name="course" required>
                    <option>B.E.</option>
                    <option>M.E.</option>
                </select>
                <br>
                <label for="semester">Select Semester:</label>
                <select class="form-control" id="semester" name="semester" required>
                    <option>I</option>
                    <option>II</option>
                    <option>III</option>
                    <option>IV</option>
                    <option>V</option>
                    <option>VI</option>
                    <option>VII</option>
                    <option>VIII</option>
                </select>
                <br>
                <label for="branch">Select Branch:</label>
                <select class="form-control" id="branch" name="branch" required>
                    <option>CSE</option>
                    <option>IT</option>
                    <option>ECE</option>
                    <option>EEE</option>
                    <option>Mech</option>
                    <option>BioTech</option>
                </select>
                <br>
                <label for="subject">Select Subject:</label>
                <select class="form-control" id="subject" name="subject" required>
                    <option>Compiler Design</option>
                    <option>Digital Signal Processing</option>
                    <option>Cloud Computing</option>
                    <option>Agile Development</option>
                </select>
                <br><br>
                <div style="text-align: center;">
                    <button type="submit" class="btn btn-primary coe-submit-btn" id="f_submit">Submit</button>
                    <!-- When finalize is clicked, we want to fetch the pending finalization papers -->
                    <button type="submit" class="btn btn-secondary coe-finalize-btn" data-toggle="modal" data-target="#myModal-1" id="finalize">Finalize</button>
                </div>
            </div>
        </form>

        <div class="table-responsive coe-teacher-table" style="margin-top: 30px; display: none; opacity: 0;">
            <table class="table table-bordered table-hover">
                <thead>
                    <tr>
                        <th>Teacher's Name</th>
                        <th>Request</th>
                    </tr>
                </thead>
                <tbody id="getteachers">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Request Status Tab -->
    <div id="arequest" class="container tab-pane fade"><br>
        {% if arr %}
        <div class="table-responsive table-hover coe-request-status-table" style="margin-top: 20px;">
            <table class="table table-bordered" id="myTable">
                <thead>
                    <tr>
                        <th>Teacher's Name</th>
                        <th>Request Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for a in arr %}
                    <tr>
                        <td>{{ a.name }}</td>
                        {% if a.status == 'Pending' %}
                        <td class="status-pending">{{ a.status }}</td>
                        {% elif a.status == 'Accepted' %}
                        <td class="status-accepted">{{ a.status }}</td>
                        {% else %}
                        <td class="status-completed">{{ a.status }}</td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="card bg-light text-dark no-request coe-no-request-card" style="margin-top: 20px;">
            <div class="card-body" style="text-align: center;">
                No Sent Requests.
            </div>
        </div>
        {% endif %}

        <div class="show coe-latest-requests" style="display: none; margin-top: 30px;">
            <h4 style="text-align: center; margin-bottom: 20px;">Latest Requests</h4>
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead>
                        <tr>
                            <th>Teacher's Name</th>
                            <th>Request Status</th>
                        </tr>
                    </thead>
                    <tbody id="showteachers">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Finalize Modal -->
<div class="modal fade coe-modal" id="myModal-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header coe-modal-header">
                <h4 class="modal-title">Select a Paper for Finalization</h4>
                <button type="button" class="close" data-dismiss="modal">×</button>
            </div>
            <!-- Modal body: list of pending finalization papers -->
            <form method="POST">{% csrf_token %}
                <input type="text" name="s_code" id="s_code_field" style="display: none;">
                <input type="text" name="t_id" id="t_id" style="display: none;">
                <div class="modal-body final_teachers coe-modal-body">
                    <!-- This will be populated by AJAX with radio buttons for each pending finalization paper -->
                </div>
                <!-- Modal footer -->
                <div class="modal-footer coe-modal-footer">
                    <button type="submit" class="btn btn-success coe-modal-finalize-btn" id="finalized">Finalize Paper</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal for Sending Request -->
<div class="modal fade coe-modal" id="myModal">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body coe-modal-body">
                <form method="POST" id="form-1" class="coe-modal-form" submit-url="{% url 'add_teacher' %}" enctype="multipart/form-data">{%csrf_token %}
                    <input type="text" name="g_id" id="g_id" style="display: none;">
                    <div class="form-group">
                        <label for="s_code">Subject Code:</label>
                        <input type="text" name="s_code" class="form-control" id="s_code" required>
                    </div>
                    <label for="customFile-1">Syllabus:</label>
                    <div class="custom-file mb-3">
                        <input type="file" class="custom-file-input" id="customFile-1" name="syllabus"
                            accept="application/pdf" required>
                        <label class="custom-file-label" for="customFile-1">Choose file</label>
                    </div>
                    <label for="customFile-2">Question Pattern:</label>
                    <div class="custom-file mb-3">
                        <input type="file" class="custom-file-input" id="customFile-2" name="q_pattern"
                            accept="application/pdf" required>
                        <label class="custom-file-label" for="customFile-2">Choose file</label>
                    </div>
                    <div class="form-group">
                        <label for="deadline">Paper Submission Deadline:</label>
                        <input type="datetime-local" name="paper_deadline" class="form-control" id="deadline" required>
                    </div>
                    <div class="form-group">
                        <label for="exam_time">Exam Time:</label>
                        <input type="datetime-local" name="exam_time" class="form-control" id="exam_time" required>
                    </div>
            </div>
            <!-- Modal footer -->
            <div class="modal-footer coe-modal-footer">
                <button type="submit" class="btn btn-primary coe-modal-confirm-btn">Confirm Request</button>
            </div>
            </form>
        </div>
    </div>
</div>

<script type="text/javascript">
    function check(ans) {
        document.getElementById("t_id").value = ans;
    }

    $(document).ready(function () {
        var g_id = 0;
        var btn_click = 0;

        $('#f_submit').click(function () {
            btn_click = 0;
        });

        $('#finalize').click(function () {
            btn_click = 1;

            // **Drastic Solution: Override Bootstrap Modal for #myModal-1 to prevent backdrop**
            $('#myModal-1').modal = function (options) {
                // Call the original Bootstrap modal function, but override backdrop option to 'false'
                $.fn.modal.Constructor.prototype.show.call($('#myModal-1'), $.extend({}, options, { backdrop: false }));
            };


            // Now show the modal using the overridden function
            $("#myModal-1").modal('show');
        });

        $('#form').submit(function () { // catch the form's submit event
            $.ajax({ // create an AJAX call...
                data: $(this).serialize(), // get the form data
                type: $(this).attr('method'), // GET or POST
                url: $(this).attr('submit-url'), // the URL to call
                success: function (data) {
                    var s_code = data.s_code;
                    var queryset2 = data.queryset2; // now should return requests with status "Pending Finalization"
                    var dataTeachers = data.queryset;
                    if (btn_click == 1) {
                        var p_no = 1;
                        $('.final_teachers').empty();
                        $('#s_code_field').val(s_code);
                        $('#finalized').attr('disabled', false);
                        if (queryset2.length > 0) {
                            for (teacher of queryset2) {
                                $(".final_teachers").append('<div class="custom-control custom-radio"><input type="radio" class="custom-control-input" id="' + teacher["id"] + '" name="papers" onclick="check(this.id)" required><label class="custom-control-label" for="' + teacher["id"] + '">Paper ' + p_no + '</label></div>');
                                p_no = p_no + 1;
                            }
                        } else {
                            $('.final_teachers').html("No pending finalization papers found!");
                            $('#finalized').attr('disabled', true);
                        }
                    } else {
                        if (dataTeachers.length > 0) {
                            $('.alerts').empty();
                            $('.coe-teacher-table').css("display", "block").css("opacity", "0").animate({ opacity: 1 }, 300);
                            $('#getteachers').empty();
                            for (teacher of dataTeachers) {
                                $('#s_code').val(s_code);
                                $('#getteachers').append('<tr id="row_' + teacher["id"] + '"><td>' + teacher["first_name"] + " " + teacher["last_name"] + '</td><td>' + '<button class="btn btn-primary send_request" id="' + teacher["id"] + '">Send Request</button></td></tr>');
                            }
                            $('html, body').animate({
                                scrollTop: ($('.table-responsive').offset().top)
                            }, 500);
                        } else {
                            $(window).scrollTop(0);
                            $(".alerts").html('<div class="alert alert-danger alert-dismissible fade show coe-alert" role="alert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span></button>No results found!</div>');
                        }
                    }

                    $(".send_request").click(function () {
                        $("#myModal").modal("show");
                        g_id = this.id;
                        $('#g_id').val(g_id);
                    });
                }
            });
            return false;
        });

        $('#form-1').submit(function () {
            var data = new FormData($('#form-1').get(0));
            $.ajax({
                data: data,
                type: $(this).attr('method'),
                url: $(this).attr('submit-url'),
                cache: false,
                processData: false,
                contentType: false,
                success: function (new_data) {
                    var new_teacher = new_data.new_teacher;
                    $('.coe-latest-requests').css('display', 'block').hide().slideDown(300);
                    $('.card').css('display', 'none');
                    $('.alerts').empty();
                    $(".alerts").html('<div class="alert alert-success alert-dismissible fade show coe-alert" role="alert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span></button>Request Sent! This request can be tracked in the Request Status section.</div>');
                    $("#myModal").modal("hide");
                    $("#row_" + g_id).remove();
                    $(window).scrollTop(0);
                    for (teacher of new_teacher) {
                        $('#showteachers').append('<tr><td>' + teacher["first_name"] + " " + teacher["last_name"] + '</td><td class="status-pending"> Pending </td></tr>');
                    }
                }
            });
            return false;
        });
    });

    $(".custom-file-input").on("change", function () {
        var fileName = $(this).val().split("\\").pop();
        $(this).siblings(".custom-file-label").addClass("selected").html(fileName);
    });


</script>
{% endblock %}